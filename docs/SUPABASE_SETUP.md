# ðŸ—„ï¸ Supabase Setup â€” Daisy's Med Spa AI Voice Agent

Everything you need to configure a **fresh Supabase project** from scratch.

---

## Step 1 â€” Create a Supabase project

1. Go to [app.supabase.com](https://app.supabase.com) and sign in
2. Click **New Project**
3. Choose your organisation, give it a name (e.g. `daisy-med-spa`), set a database password, pick the **Mumbai (ap-south-1)** region
4. Click **Create new project** and wait ~2 minutes

---

## Step 2 â€” Get your API credentials

1. Go to **Settings â†’ API**
2. Copy:
   - **Project URL** â†’ paste as `SUPABASE_URL` in your `.env`
   - **anon / public key** â†’ paste as `SUPABASE_KEY` in your `.env`

---

## Step 3 â€” Run the database SQL

Go to **SQL Editor â†’ New Query**, paste the entire block below, and click **Run**.

```sql
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- CALL LOGS TABLE
-- Stores every inbound/outbound call with transcript, recording, and metadata.
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE IF NOT EXISTS call_logs (
    id               bigint generated by default as identity primary key,
    created_at       timestamp with time zone default timezone('utc', now()) not null,
    phone_number     text,
    caller_name      text,
    duration_seconds integer,
    transcript       text,
    summary          text,
    recording_url    text,
    caller_email     text,
    tts_voice        text
);

-- Enable Row Level Security
ALTER TABLE call_logs ENABLE ROW LEVEL SECURITY;

-- Allow full access via the service/anon key used by the backend
CREATE POLICY "Enable all actions for service role"
    ON call_logs
    FOR ALL
    USING (true);


-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- STORAGE â€” Call Recordings Bucket
-- Makes the call-recordings bucket publicly readable so recording URLs work.
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

INSERT INTO storage.buckets (id, name, public)
VALUES ('call-recordings', 'call-recordings', true)
ON CONFLICT (id) DO UPDATE SET public = true;

-- Allow public read (so the /storage/v1/object/public/... URL works)
CREATE POLICY "Public read recordings"
    ON storage.objects
    FOR SELECT
    USING (bucket_id = 'call-recordings');

-- Allow the backend (LiveKit Egress via S3) to upload recordings
CREATE POLICY "Service role write recordings"
    ON storage.objects
    FOR INSERT
    WITH CHECK (bucket_id = 'call-recordings');
```

> âœ… You should see **Success. No rows returned** â€” that means it worked.

---

## Step 4 â€” Create the Storage bucket (UI)

Even though the SQL above registers the bucket, you may need to create it manually:

1. Go to **Storage â†’ New Bucket**
2. Name: `call-recordings`
3. Set to **Private**
4. Click **Create bucket**

Then run the SQL from Step 3 to apply the public-read policy.

---

## Step 5 â€” Generate S3 credentials for call recording

1. Go to **Storage â†’ Settings â†’ S3 Access**
2. Click **Generate new access key**
3. Copy the values and add them to your `.env`:

```env
SUPABASE_S3_ACCESS_KEY=your_access_key_id
SUPABASE_S3_SECRET_KEY=your_secret_access_key
SUPABASE_S3_ENDPOINT=https://YOUR_PROJECT_REF.supabase.co/storage/v1/s3
SUPABASE_S3_REGION=ap-south-1
```

> Your project ref is the subdomain in your Supabase URL.
> e.g. if URL is `https://abcxyz.supabase.co` â†’ endpoint is `https://abcxyz.supabase.co/storage/v1/s3`

---

## Step 6 â€” Verify the setup

Run this query in **SQL Editor** to confirm the table exists and has the right columns:

```sql
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'call_logs'
ORDER BY ordinal_position;
```

Expected output:

| column_name | data_type |
|---|---|
| id | bigint |
| created_at | timestamp with time zone |
| phone_number | text |
| caller_name | text |
| duration_seconds | integer |
| transcript | text |
| summary | text |
| recording_url | text |
| caller_email | text |
| tts_voice | text |

---

## Reference â€” All SQL in one block (copy-paste ready)

```sql
-- 1. call_logs table
CREATE TABLE IF NOT EXISTS call_logs (
    id               bigint generated by default as identity primary key,
    created_at       timestamp with time zone default timezone('utc', now()) not null,
    phone_number     text,
    caller_name      text,
    duration_seconds integer,
    transcript       text,
    summary          text,
    recording_url    text,
    caller_email     text,
    tts_voice        text
);
ALTER TABLE call_logs ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Enable all actions for service role" ON call_logs FOR ALL USING (true);

-- 2. Storage bucket
INSERT INTO storage.buckets (id, name, public) VALUES ('call-recordings', 'call-recordings', true)
ON CONFLICT (id) DO UPDATE SET public = true;
CREATE POLICY "Public read recordings" ON storage.objects FOR SELECT USING (bucket_id = 'call-recordings');
CREATE POLICY "Service role write recordings" ON storage.objects FOR INSERT WITH CHECK (bucket_id = 'call-recordings');
```
